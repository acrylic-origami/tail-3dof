/*
 * as1130.c
 *
 *  Created on: May 14, 2020
 *      Author: derek-lam
 */
#include "stm32f1xx_hal.h"
#include "as1130.h"
#include "consts.h"
#include <string.h>

extern I2C_HandleTypeDef hi2c1;

const uint8_t AS1130_setup_sizes[AS1130_SETUP_NUM_STEPS] = {
  2, 2, // CONFIG
  2, 2, // CLK
  2, 2, // CURR
  2, 2, // DSP/
  2, 2, // SHDN
  2, 2, // PIC_EN
  2, 25, // ON-OFF
  2, 157, // PX0
}; // configuration problem: can't change frames after either on-off register or pic-en it seems
const uint8_t AS1130_setup[] = {
  0xFD, 0xC0,
  0x06, 0b10100001, // CONFIG

  0xFD, 0xC0,
  0x0B, 0b1110, // CLK

  0xFD, 0xC0,
  0x05, 0x40, // CURR

  0xFD, 0xC0,
  0x04, 0xEB, // DSP

  0xFD, 0xC0,
  0x09, 0b10111, // SHDN

  0xFD, 0xC0,
  0x00, 0x40, // PIC_EN

  0xFD, 0x01, // ON-OFF
  0x00,
    0xFF, 0x07, // select PWM frame 0
    0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07,

  0xFD, 0x40,
  0x00, // PX
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // no blink
	// unset all pxs
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,

};
uint8_t e;
void AS1130_Init(void) {
	HAL_Delay(10); // give AS1130 >5ms to setup I2C address (as spec'd)

	uint8_t step = 0;
	for(uint8_t i = 0; i < AS1130_SETUP_NUM_STEPS; i++) {
		e = HAL_I2C_Master_Transmit(&hi2c1, AS1130_ADDR, &(AS1130_setup[step]), AS1130_setup_sizes[i], -1);
		step += AS1130_setup_sizes[i];
	}
}

const uint8_t bump[NBUMP][NBUMP] = {{1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1},
{1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 1},
{1, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 3, 3, 3, 2, 2, 1},
{2, 2, 3, 3, 4, 4, 5, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 6, 6, 6, 5, 4, 4, 3, 3, 2, 2},
{2, 2, 3, 4, 5, 6, 6, 7, 8, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 9, 9, 9, 9, 8, 7, 6, 6, 5, 4, 3, 2, 2},
{2, 3, 3, 4, 6, 7, 8, 10, 11, 12, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 13, 13, 12, 11, 10, 8, 7, 6, 4, 3, 3, 2},
{2, 3, 4, 5, 6, 8, 10, 12, 15, 17, 18, 19, 20, 20, 20, 20, 20, 20, 20, 20, 19, 18, 17, 15, 12, 10, 8, 6, 5, 4, 3, 2},
{2, 3, 4, 6, 7, 10, 12, 16, 20, 23, 26, 28, 29, 30, 30, 30, 30, 30, 30, 29, 28, 26, 23, 20, 16, 12, 10, 7, 6, 4, 3, 2},
{2, 3, 4, 6, 8, 11, 15, 20, 25, 32, 38, 42, 45, 46, 46, 47, 47, 46, 46, 45, 42, 38, 32, 25, 20, 15, 11, 8, 6, 4, 3, 2},
{3, 3, 5, 6, 9, 12, 17, 23, 32, 42, 53, 62, 68, 71, 72, 73, 73, 72, 71, 68, 62, 53, 42, 32, 23, 17, 12, 9, 6, 5, 3, 3},
{3, 3, 5, 7, 9, 13, 18, 26, 38, 53, 71, 89, 102, 109, 111, 112, 112, 111, 109, 102, 89, 71, 53, 38, 26, 18, 13, 9, 7, 5, 3, 3},
{3, 4, 5, 7, 9, 13, 19, 28, 42, 62, 89, 119, 143, 157, 161, 162, 162, 161, 157, 143, 119, 89, 62, 42, 28, 19, 13, 9, 7, 5, 4, 3},
{3, 4, 5, 7, 9, 14, 20, 29, 45, 68, 102, 143, 180, 202, 210, 211, 211, 210, 202, 180, 143, 102, 68, 45, 29, 20, 14, 9, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 46, 71, 109, 157, 202, 230, 241, 242, 242, 241, 230, 202, 157, 109, 71, 46, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 46, 72, 111, 161, 210, 241, 252, 254, 254, 252, 241, 210, 161, 111, 72, 46, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 47, 73, 112, 162, 211, 242, 254, 255, 255, 254, 242, 211, 162, 112, 73, 47, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 47, 73, 112, 162, 211, 242, 254, 255, 255, 254, 242, 211, 162, 112, 73, 47, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 46, 72, 111, 161, 210, 241, 252, 254, 254, 252, 241, 210, 161, 111, 72, 46, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 10, 14, 20, 30, 46, 71, 109, 157, 202, 230, 241, 242, 242, 241, 230, 202, 157, 109, 71, 46, 30, 20, 14, 10, 7, 5, 4, 3},
{3, 4, 5, 7, 9, 14, 20, 29, 45, 68, 102, 143, 180, 202, 210, 211, 211, 210, 202, 180, 143, 102, 68, 45, 29, 20, 14, 9, 7, 5, 4, 3},
{3, 4, 5, 7, 9, 13, 19, 28, 42, 62, 89, 119, 143, 157, 161, 162, 162, 161, 157, 143, 119, 89, 62, 42, 28, 19, 13, 9, 7, 5, 4, 3},
{3, 3, 5, 7, 9, 13, 18, 26, 38, 53, 71, 89, 102, 109, 111, 112, 112, 111, 109, 102, 89, 71, 53, 38, 26, 18, 13, 9, 7, 5, 3, 3},
{3, 3, 5, 6, 9, 12, 17, 23, 32, 42, 53, 62, 68, 71, 72, 73, 73, 72, 71, 68, 62, 53, 42, 32, 23, 17, 12, 9, 6, 5, 3, 3},
{2, 3, 4, 6, 8, 11, 15, 20, 25, 32, 38, 42, 45, 46, 46, 47, 47, 46, 46, 45, 42, 38, 32, 25, 20, 15, 11, 8, 6, 4, 3, 2},
{2, 3, 4, 6, 7, 10, 12, 16, 20, 23, 26, 28, 29, 30, 30, 30, 30, 30, 30, 29, 28, 26, 23, 20, 16, 12, 10, 7, 6, 4, 3, 2},
{2, 3, 4, 5, 6, 8, 10, 12, 15, 17, 18, 19, 20, 20, 20, 20, 20, 20, 20, 20, 19, 18, 17, 15, 12, 10, 8, 6, 5, 4, 3, 2},
{2, 3, 3, 4, 6, 7, 8, 10, 11, 12, 13, 13, 14, 14, 14, 14, 14, 14, 14, 14, 13, 13, 12, 11, 10, 8, 7, 6, 4, 3, 3, 2},
{2, 2, 3, 4, 5, 6, 6, 7, 8, 9, 9, 9, 9, 10, 10, 10, 10, 10, 10, 9, 9, 9, 9, 8, 7, 6, 6, 5, 4, 3, 2, 2},
{2, 2, 3, 3, 4, 4, 5, 6, 6, 6, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 6, 6, 6, 5, 4, 4, 3, 3, 2, 2},
{1, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 4, 4, 4, 3, 3, 3, 2, 2, 1},
{1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 1},
{1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 2, 2, 2, 2, 2, 2, 1, 1, 1}};

const uint8_t AS1130_xy2idx_lookup[ARRAY_ROWS][ARRAY_COLS] = {
		{ 63,52,41,30,119,8 },
		{ 131,120,109,98,87,76 },
		{ 64,53,42,31,20,9 },
		{ 122,111,100,89,78,67 },
		{ 55,44,33,22,11,0 },
		{ 123,112,101,90,79,68 },
		{ 56,45,34,23,12,1 },
		{ 124,113,102,91,80,69 },
		{ 57,46,35,24,13,2 },
		{ 125,114,103,92,81,70 },
		{ 58,47,36,25,14,3 },
		{ 126,115,104,93,82,71 },
};

const uint8_t ARRAY_DIMS[2] = { ARRAY_COLS, ARRAY_ROWS };
uint8_t blit_buf[NUM_PXS + 1];
uint8_t AS1130_blit(uint8_t *A, uint16_t *Adims, uint16_t *loc, uint16_t *scale) {
	// expect row-major A, stride is # cols
	// scale[2] is XY nomalized of the image size, 256-units
	// loc[2] is XY normalized of the array size, 256-units
	// centering is center-aligned, antialiasing is top-left-corner aligned
	if(hi2c1.State == HAL_I2C_STATE_READY) {
		memset(blit_buf, 0, NUM_PXS + 1);
		uint8_t tdims[2];
		int16_t t0[2];
		int16_t tcent[2];
		int16_t dmid_a[2]; // fractions of a-pixels relative to nearest top-left t-pixel, 0~1
		for(uint8_t i = 0; i < 2; i++) {
			tdims[i] = scale[i] * Adims[i] >> _W;
			tcent[i] = (loc[i] * ARRAY_DIMS[i] >> _W);
			t0[i] = tcent[i] - tdims[i] / 2;
			dmid_a[i] = ((loc[i] * ARRAY_DIMS[i] - ((loc[i] * ARRAY_DIMS[i]) & 0xFFFFFF00)) << _W) / scale[i];
		}

		for(int8_t tx = t0[0] + tdims[0]; tx >= t0[0]; tx--) {
			for(int8_t ty = t0[1] + tdims[1]; ty >= t0[1]; ty--) {
				int8_t ts[2] = { tx, ty };
				if(
					tx >= 0 && tx < ARRAY_COLS &&
					ty >= 0 && ty < ARRAY_ROWS
				) {
					int16_t as[2];
					int16_t _go = 1;
					for(uint8_t i = 0; i < 2; i++) {
						as[i] = (((int16_t)ts[i] - tcent[i]) << _W) / scale[i] + Adims[i] / 2 - (dmid_a[i] >> _W);
						if(as[i] < 0 || as[i] >= Adims[i])
							_go = 0;
					}

					if(_go) {
						volatile uint8_t idx = AS1130_xy2idx_lookup[ty][tx]; // AS1130_xy2idx(tx, ty) + 1;
						blit_buf[idx + 1] = A[as[1] * Adims[0] + as[0]];
					}
				}
			}
		}
		blit_buf[0] = 0x18;
		HAL_I2C_Master_Transmit(&hi2c1, AS1130_ADDR, blit_buf, NUM_PXS + 1, -1);
		return 0;
	}
	else {
		return 1;
	}
}

uint8_t AS1130_xy2idx(uint8_t x, uint8_t y) {
	y += 10;
	uint8_t a = y >> 1;
	uint8_t b = ((y & 1) ? 6 : 0) + x;
	return b * 11 + a;
}
