/*
 * as1130.c
 *
 *  Created on: May 14, 2020
 *      Author: derek-lam
 */
#include "stm32f1xx_hal.h"
#include "as1130.h"
#include "consts.h"
#include <string.h>

extern I2C_HandleTypeDef hi2c1;

const uint8_t AS1130_setup_sizes[AS1130_SETUP_NUM_STEPS] = {
  2, 2, // CONFIG
  2, 2, // CLK
  2, 2, // CURR
  2, 2, // DSP/
  2, 2, // SHDN
  2, 2, // PIC_EN
  2, 25, // ON-OFF
  2, 157, // PX0
}; // configuration problem: can't change frames after either on-off register or pic-en it seems
const uint8_t AS1130_setup[] = {
  0xFD, 0xC0,
  0x06, 0b10100001, // CONFIG

  0xFD, 0xC0,
  0x0B, 0b1110, // CLK

  0xFD, 0xC0,
  0x05, 0x40, // CURR

  0xFD, 0xC0,
  0x04, 0xEB, // DSP

  0xFD, 0xC0,
  0x09, 0b10111, // SHDN

  0xFD, 0xC0,
  0x00, 0x40, // PIC_EN

  0xFD, 0x01, // ON-OFF
  0x00,
    0xFF, 0x07, // select PWM frame 0
    0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07, 0xFF, 0x07,

  0xFD, 0x40,
  0x00, // PX
	0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0, // no blink
	// unset all pxs
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
	0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,

};
uint8_t e;
void AS1130_Init(void) {
	HAL_Delay(10); // give AS1130 >5ms to setup I2C address (as spec'd)

	uint8_t step = 0;
	for(uint8_t i = 0; i < AS1130_SETUP_NUM_STEPS; i++) {
		e = HAL_I2C_Master_Transmit(&hi2c1, AS1130_ADDR, &(AS1130_setup[step]), AS1130_setup_sizes[i], -1);
		step += AS1130_setup_sizes[i];
	}
}

const uint8_t bump[NBUMP][NBUMP] = {{28, 30, 31, 33, 35, 37, 39, 41, 43, 44, 46, 47, 49, 50, 50, 51, 51, 50, 50, 49, 47, 46, 44, 43, 41, 39, 37, 35, 33, 31, 30, 28},
{30, 31, 33, 36, 38, 40, 42, 44, 47, 49, 51, 52, 54, 55, 56, 56, 56, 56, 55, 54, 52, 51, 49, 47, 44, 42, 40, 38, 36, 33, 31, 30},
{31, 33, 36, 38, 41, 43, 46, 48, 51, 54, 56, 58, 60, 61, 62, 63, 63, 62, 61, 60, 58, 56, 54, 51, 48, 46, 43, 41, 38, 36, 33, 31},
{33, 36, 38, 41, 44, 47, 50, 53, 56, 59, 62, 64, 67, 69, 70, 71, 71, 70, 69, 67, 64, 62, 59, 56, 53, 50, 47, 44, 41, 38, 36, 33},
{35, 38, 41, 44, 47, 50, 54, 58, 61, 65, 69, 72, 75, 77, 79, 79, 79, 79, 77, 75, 72, 69, 65, 61, 58, 54, 50, 47, 44, 41, 38, 35},
{37, 40, 43, 47, 50, 54, 59, 63, 67, 72, 76, 80, 84, 87, 89, 90, 90, 89, 87, 84, 80, 76, 72, 67, 63, 59, 54, 50, 47, 43, 40, 37},
{39, 42, 46, 50, 54, 59, 63, 69, 74, 79, 85, 90, 94, 98, 100, 102, 102, 100, 98, 94, 90, 85, 79, 74, 69, 63, 59, 54, 50, 46, 42, 39},
{41, 44, 48, 53, 58, 63, 69, 75, 81, 88, 94, 100, 106, 110, 114, 115, 115, 114, 110, 106, 100, 94, 88, 81, 75, 69, 63, 58, 53, 48, 44, 41},
{43, 47, 51, 56, 61, 67, 74, 81, 89, 96, 104, 112, 119, 125, 129, 131, 131, 129, 125, 119, 112, 104, 96, 89, 81, 74, 67, 61, 56, 51, 47, 43},
{44, 49, 54, 59, 65, 72, 79, 88, 96, 106, 115, 125, 134, 141, 147, 149, 149, 147, 141, 134, 125, 115, 106, 96, 88, 79, 72, 65, 59, 54, 49, 44},
{46, 51, 56, 62, 69, 76, 85, 94, 104, 115, 127, 139, 149, 159, 166, 169, 169, 166, 159, 149, 139, 127, 115, 104, 94, 85, 76, 69, 62, 56, 51, 46},
{47, 52, 58, 64, 72, 80, 90, 100, 112, 125, 139, 152, 166, 177, 186, 190, 190, 186, 177, 166, 152, 139, 125, 112, 100, 90, 80, 72, 64, 58, 52, 47},
{49, 54, 60, 67, 75, 84, 94, 106, 119, 134, 149, 166, 181, 195, 206, 211, 211, 206, 195, 181, 166, 149, 134, 119, 106, 94, 84, 75, 67, 60, 54, 49},
{50, 55, 61, 69, 77, 87, 98, 110, 125, 141, 159, 177, 195, 211, 224, 231, 231, 224, 211, 195, 177, 159, 141, 125, 110, 98, 87, 77, 69, 61, 55, 50},
{50, 56, 62, 70, 79, 89, 100, 114, 129, 147, 166, 186, 206, 224, 238, 245, 245, 238, 224, 206, 186, 166, 147, 129, 114, 100, 89, 79, 70, 62, 56, 50},
{51, 56, 63, 71, 79, 90, 102, 115, 131, 149, 169, 190, 211, 231, 245, 253, 253, 245, 231, 211, 190, 169, 149, 131, 115, 102, 90, 79, 71, 63, 56, 51},
{51, 56, 63, 71, 79, 90, 102, 115, 131, 149, 169, 190, 211, 231, 245, 253, 253, 245, 231, 211, 190, 169, 149, 131, 115, 102, 90, 79, 71, 63, 56, 51},
{50, 56, 62, 70, 79, 89, 100, 114, 129, 147, 166, 186, 206, 224, 238, 245, 245, 238, 224, 206, 186, 166, 147, 129, 114, 100, 89, 79, 70, 62, 56, 50},
{50, 55, 61, 69, 77, 87, 98, 110, 125, 141, 159, 177, 195, 211, 224, 231, 231, 224, 211, 195, 177, 159, 141, 125, 110, 98, 87, 77, 69, 61, 55, 50},
{49, 54, 60, 67, 75, 84, 94, 106, 119, 134, 149, 166, 181, 195, 206, 211, 211, 206, 195, 181, 166, 149, 134, 119, 106, 94, 84, 75, 67, 60, 54, 49},
{47, 52, 58, 64, 72, 80, 90, 100, 112, 125, 139, 152, 166, 177, 186, 190, 190, 186, 177, 166, 152, 139, 125, 112, 100, 90, 80, 72, 64, 58, 52, 47},
{46, 51, 56, 62, 69, 76, 85, 94, 104, 115, 127, 139, 149, 159, 166, 169, 169, 166, 159, 149, 139, 127, 115, 104, 94, 85, 76, 69, 62, 56, 51, 46},
{44, 49, 54, 59, 65, 72, 79, 88, 96, 106, 115, 125, 134, 141, 147, 149, 149, 147, 141, 134, 125, 115, 106, 96, 88, 79, 72, 65, 59, 54, 49, 44},
{43, 47, 51, 56, 61, 67, 74, 81, 89, 96, 104, 112, 119, 125, 129, 131, 131, 129, 125, 119, 112, 104, 96, 89, 81, 74, 67, 61, 56, 51, 47, 43},
{41, 44, 48, 53, 58, 63, 69, 75, 81, 88, 94, 100, 106, 110, 114, 115, 115, 114, 110, 106, 100, 94, 88, 81, 75, 69, 63, 58, 53, 48, 44, 41},
{39, 42, 46, 50, 54, 59, 63, 69, 74, 79, 85, 90, 94, 98, 100, 102, 102, 100, 98, 94, 90, 85, 79, 74, 69, 63, 59, 54, 50, 46, 42, 39},
{37, 40, 43, 47, 50, 54, 59, 63, 67, 72, 76, 80, 84, 87, 89, 90, 90, 89, 87, 84, 80, 76, 72, 67, 63, 59, 54, 50, 47, 43, 40, 37},
{35, 38, 41, 44, 47, 50, 54, 58, 61, 65, 69, 72, 75, 77, 79, 79, 79, 79, 77, 75, 72, 69, 65, 61, 58, 54, 50, 47, 44, 41, 38, 35},
{33, 36, 38, 41, 44, 47, 50, 53, 56, 59, 62, 64, 67, 69, 70, 71, 71, 70, 69, 67, 64, 62, 59, 56, 53, 50, 47, 44, 41, 38, 36, 33},
{31, 33, 36, 38, 41, 43, 46, 48, 51, 54, 56, 58, 60, 61, 62, 63, 63, 62, 61, 60, 58, 56, 54, 51, 48, 46, 43, 41, 38, 36, 33, 31},
{30, 31, 33, 36, 38, 40, 42, 44, 47, 49, 51, 52, 54, 55, 56, 56, 56, 56, 55, 54, 52, 51, 49, 47, 44, 42, 40, 38, 36, 33, 31, 30},
{28, 30, 31, 33, 35, 37, 39, 41, 43, 44, 46, 47, 49, 50, 50, 51, 51, 50, 50, 49, 47, 46, 44, 43, 41, 39, 37, 35, 33, 31, 30, 28}};

uint8_t blit_buf[NUM_PXS + 1];
#define ARRAY_ROWS 10
#define ARRAY_COLS 6
#define ARRAY_ROW_FOLDING 2
uint8_t AS1130_blit(uint8_t *A, uint16_t ncols, uint16_t nrows, uint16_t *loc, uint16_t *scale) {
	// expect row-major A, stride is # cols
	// scale[2] is XY nomalized of the image size, 256-units
	// loc[2] is XY normalized of the array size, 256-units
	if(hi2c1.State == HAL_I2C_STATE_READY) {
		memset(blit_buf, 0, NUM_PXS + 1);
		uint8_t tw = scale[0] * ncols >> _W, th = scale[1] * nrows >> _W;
		uint8_t tx0 = loc[0] * ARRAY_COLS >> _W, ty0 = loc[1] * ARRAY_ROWS >> _W;
		for(uint8_t ay = 0; ay < th; ay++) {
			for(uint8_t ax = 0; ax < tw; ax++) {
				uint8_t tx = tx0 - tw / 2 + ax,
						ty = ty0 - tw / 2 + ay;
				if(
					tx >= 0 && tx < ARRAY_COLS &&
					ty >= 0 && ty < ARRAY_ROWS
				) {
					blit_buf[AS1130_xy2idx(tx, ty) + 1] = A[(ay * (nrows - 1) / (th - 1)) * ncols + (ax * (ncols - 1) / (tw - 1))];
				}
			}
		}
		blit_buf[0] = 0x18;
		HAL_I2C_Master_Transmit(&hi2c1, AS1130_ADDR, blit_buf, NUM_PXS + 1, -1);
		return 0;
	}
	else {
		return 1;
	}
}

uint8_t AS1130_xy2idx(uint8_t x, uint8_t y) {
	y += 5;
	uint8_t a = y >> 1;
	uint8_t b = ((y & 1) ? 6 : 0) + x;
	return b * 11 + a;
}
